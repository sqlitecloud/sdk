--** launch n concurrent writers, can't be run concurrently multiple times because 
--** it check the number of connection at the end of the script and tries to delete the db

--set dbname=tester_nwriters1.sqlite
--set n=50
CREATE DATABASE {{.dbname}} IF NOT EXISTS; USE DATABASE {{.dbname}};
--match type is ok
CREATE TABLE IF NOT EXISTS t1(a INTEGER PRIMARY KEY, b); DELETE FROM t1;
--match type is ok

--loop i=1; i<=n; i=i+1;
    --task i NAME insert
        USE DATABASE {{.dbname}}
        INSERT INTO t1 (b) VALUES ({{.i}});
        -- --dump
        -- the following exit command is commented to avoid a tls handshake error with the localhost server on mac
        -- --exit
    --end
--end

--wait all

--loop i=1; i<=n; i=i+1;
    --task i NAME exit
        --exit
    --end
--end

--wait all

-- this value can be less then "n" if some concurrent INSERT commands fail for concurrency issues
SELECT COUNT(*) FROM t1;
--dump

UNUSE DATABASE;
--match type is ok

----sleep 100
LIST CONNECTIONS;
-- --match cols 6
LIST DATABASE CONNECTIONS {{.dbname}};
-- --dump
--match rows 0
DROP DATABASE {{.dbname}};
--match type is ok
