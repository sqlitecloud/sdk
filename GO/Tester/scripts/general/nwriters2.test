--** launch n concurrent writers, it can be invoked multiple times concurrently
--** for example using goreman (see Procfile)

--set dbname=tester_nwriters2.sqlite
--set n=50
CREATE DATABASE {{.dbname}} IF NOT EXISTS; USE DATABASE {{.dbname}};
--match type is ok
CREATE TABLE IF NOT EXISTS t1(a INTEGER PRIMARY KEY, b); DELETE FROM t1;
--match type is ok

--loop i=1; i<=n; i=i+1;
    --task i NAME insert
        USE DATABASE {{.dbname}}
        INSERT INTO t1 (b) VALUES ({{.i}});
        ----dump
        -- the following exit command is commented to avoid a tls handshake error with the localhost server on mac
        ----exit
    --end
--end

--wait all

--loop i=1; i<=n; i=i+1;
    --task i NAME exit
        --exit
    --end
--end

--wait all

SELECT COUNT(*) FROM t1;
-- --dump

UNUSE DATABASE;
--match type is ok

----sleep 100
LIST CONNECTIONS;

REMOVE DATABASE {{.dbname}};
--match type is ok
